# =============================================================================
# LichtFeld Studio Website - Cloudflare Workers Static Assets + API
# =============================================================================
#
# Hybrid static site + API worker.
# Serves pre-built Astro SSG output from the edge, with /api/* routes handled
# by the Worker script for dynamic stats endpoint.
#
# Deployment:
#   pnpm build && wrangler deploy
#
# Local Development:
#   pnpm build && wrangler dev
#
# =============================================================================

name = "lichtfeld-studio-web"
compatibility_date = "2026-01-28"

# Note: assets_navigation_prefers_asset_serving is now default (2025-04-01+)
# No need to specify it explicitly.

# Also serve on workers.dev for testing
workers_dev = true

# Worker entry point for API routes
main = "src/api/index.ts"

# -----------------------------------------------------------------------------
# Static Assets Configuration
# -----------------------------------------------------------------------------
# Static assets served from ./dist, with Worker handling /api/* routes.
# Reference: https://developers.cloudflare.com/workers/static-assets/

[assets]
directory = "./dist"
binding = "ASSETS"
not_found_handling = "404-page"
html_handling = "auto-trailing-slash"
# Route /api/* to the Worker first, everything else to static assets
run_worker_first = ["/api/*"]

# -----------------------------------------------------------------------------
# Routes
# -----------------------------------------------------------------------------
# Catch-all route for the static site.
# The API Worker's more specific route (/api/*) takes precedence.
# Reference: https://developers.cloudflare.com/workers/configuration/routing/routes/

[[routes]]
pattern = "lichtfeld.io/*"
zone_name = "lichtfeld.io"

# -----------------------------------------------------------------------------
# D1 Database Binding
# -----------------------------------------------------------------------------
# Stats database for download statistics.
# Create via Dashboard or: wrangler d1 create lichtfeld-stats
# Reference: https://developers.cloudflare.com/d1/

[[d1_databases]]
binding = "STATS_DB"
database_name = "lichtfeld-stats"
database_id = "8e58f2af-6fff-4e6d-89b4-8aa02f719c01"

# -----------------------------------------------------------------------------
# Observability
# -----------------------------------------------------------------------------
# Enable logging and analytics in the Cloudflare Dashboard.
# Reference: https://developers.cloudflare.com/workers/observability/

[observability]
enabled = true

# -----------------------------------------------------------------------------
# Cron Triggers
# -----------------------------------------------------------------------------
# Runs hourly to collect GitHub release download statistics.
# Hourly collection keeps stats fresh throughout the day.
# Reference: https://developers.cloudflare.com/workers/configuration/cron-triggers/

[triggers]
crons = ["0 * * * *"]

# -----------------------------------------------------------------------------
# Environment Variables
# -----------------------------------------------------------------------------
# Non-sensitive configuration for the stats collector.
# For GITHUB_TOKEN, use: pnpm wrangler secret put GITHUB_TOKEN

[vars]
GITHUB_OWNER = "MrNeRF"
GITHUB_REPO = "LichtFeld-Studio"
